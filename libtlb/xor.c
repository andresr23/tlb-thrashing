#include "xor.h"

/*
 * | 1 0 0 0 0 0 0 1 0 0 0 0 0 0 |   | v[14] |   | i[ 6] |
 * | 0 1 0 0 0 0 0 0 1 0 0 0 0 0 |   |       |   | i[ 5] |
 * | 0 0 1 0 0 0 0 0 0 1 0 0 0 0 |   |  ...  |   | i[ 4] |
 * | 0 0 0 1 0 0 0 0 0 0 1 0 0 0 | . |       | = | i[ 3] |
 * | 0 0 0 0 1 0 0 0 0 0 0 1 0 0 |   |  ...  |   | i[ 2] |
 * | 0 0 0 0 0 1 0 0 0 0 0 0 1 0 |   |       |   | i[ 1] |
 * | 0 0 0 0 0 0 1 0 0 0 0 0 0 1 |   | v[ 0] |   | i[ 0] |
 *
 * @return: i.
 */
uint32_t xor_7(uint32_t v)
{
  uint32_t i = 0;
  uint32_t b[7] = {0};

  b[6] = ((v & 0x2000U) >> 13) ^ ((v & 0x0040U) >>  6);
  b[5] = ((v & 0x1000U) >> 12) ^ ((v & 0x0020U) >>  5);
  b[4] = ((v & 0x0800U) >> 11) ^ ((v & 0x0010U) >>  4);
  b[3] = ((v & 0x0400U) >> 10) ^ ((v & 0x0008U) >>  3);
  b[2] = ((v & 0x0200U) >>  9) ^ ((v & 0x0004U) >>  2);
  b[1] = ((v & 0x0100U) >>  8) ^ ((v & 0x0002U) >>  1);
  b[0] = ((v & 0x0080U) >>  7) ^ ((v & 0x0001U) >>  0);

  i |= b[6] << 6;
  i |= b[5] << 5;
  i |= b[4] << 4;
  i |= b[3] << 3;
  i |= b[2] << 2;
  i |= b[1] << 1;
  i |= b[0] << 0;

  return i;
}

/*
 * | 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 |   | v[14] |   | i[ 7] |
 * | 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 |   |       |   | i[ 6] |
 * | 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 |   |  ...  |   | i[ 5] |
 * | 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 |   |       |   | i[ 4] |
 * | 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 | . |       | = | i[ 3] |
 * | 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 |   |  ...  |   | i[ 2] |
 * | 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 |   |       |   | i[ 1] |
 * | 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 |   | v[ 0] |   | i[ 0] |
 *
 * @return: i.
 */
uint32_t xor_8(uint32_t v)
{
  uint32_t i = 0;
  uint32_t b[8] = {0};

  b[7] = ((v & 0x8000U) >> 15) ^ ((v & 0x0080U) >>  7);
  b[6] = ((v & 0x4000U) >> 14) ^ ((v & 0x0040U) >>  6);
  b[5] = ((v & 0x2000U) >> 13) ^ ((v & 0x0020U) >>  5);
  b[4] = ((v & 0x1000U) >> 12) ^ ((v & 0x0010U) >>  4);
  b[3] = ((v & 0x0800U) >> 11) ^ ((v & 0x0008U) >>  3);
  b[2] = ((v & 0x0400U) >> 10) ^ ((v & 0x0004U) >>  2);
  b[1] = ((v & 0x0200U) >>  9) ^ ((v & 0x0002U) >>  1);
  b[0] = ((v & 0x0100U) >>  8) ^ ((v & 0x0001U) >>  0);

  i |= b[7] << 7;
  i |= b[6] << 6;
  i |= b[5] << 5;
  i |= b[4] << 4;
  i |= b[3] << 3;
  i |= b[2] << 2;
  i |= b[1] << 1;
  i |= b[0] << 0;

  return i;
}

uint32_t xor_7_fast(uint32_t v)
{
  uint32_t hi = (v >> 7) & 0x7FU;
  uint32_t lo = (v >> 0) & 0x7FU;

  return (hi ^ lo);
}

uint32_t xor_8_fast(uint32_t v)
{
  uint32_t hi = (v >> 8) & 0xFFU;
  uint32_t lo = (v >> 0) & 0xFFU;

  return (hi ^ lo);
}

uint32_t xor_7_virt(void *virt)
{
  uint32_t v = (uint32_t) (((uintptr_t) virt & XOR_7_VA_MASK) >> 12);
  return xor_7_fast(v);
}

uint32_t xor_8_virt(void *virt)
{
  uint32_t v = (uint32_t) (((uintptr_t) virt & XOR_8_VA_MASK) >> 12);
  return xor_8_fast(v);
}

uint32_t inv_7(uint32_t hi, uint32_t i)
{
  i  &= 0x7FU;
  hi &= 0x7FU;

  return (hi ^ i);
}

uint32_t inv_8(uint32_t hi, uint32_t i)
{
  i  &= 0xFFU;
  hi &= 0xFFU;

  return (hi ^ i);
}
